<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard ‚Äì School ERP</title>

<style>
body{
    font-family:Poppins, sans-serif;
    background:#f4f6f9;
    margin:0;
    padding:0;
}

/* TOP BAR */
.topbar{
    width:100%;
    padding:15px 20px;
    background:#007bff;
    color:#fff;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:15px;
    box-sizing:border-box;
    position:sticky;
    top:0;
    z-index:3000;
    font-size:20px;
    font-weight:600;
}

/* LEFT HAMBURGER */
.menu-btn{
    font-size:28px;
    cursor:pointer;
    font-weight:900;
    user-select:none;
    transition:0.3s;
}
.menu-btn:hover{
    opacity:0.8;
}

/* OVERLAY */
.overlay{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.35);
    display:none;
    z-index:1400;
}
.overlay.show{ display:block; }

/* LEFT SLIDING SIDE MENU */
.side-menu{
    position:fixed;
    top:0;
    left:-280px;
    width:260px;
    height:100%;
    background:#fff;
    box-shadow:2px 0 8px rgba(0,0,0,.15);
    padding:20px;
    transition:left 0.35s cubic-bezier(0.25, 1, 0.5, 1);
    z-index:2000;
    border-radius:0 18px 18px 0;
}
.side-menu.open{ left:0; }

.menu-item{
    padding:12px 0;
    border-bottom:1px solid #eee;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
}
.menu-item:hover{ color:#007bff; }

/* DASHBOARD GRID */
.dashboard-boxes{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    padding:20px;
}

.box{
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 3px 10px rgba(0,0,0,.08);
    text-align:center;
    font-weight:600;
}
.box-title{
    font-size:14px;
    color:#666;
}
.box-value{
    font-size:30px;
    margin-top:10px;
    color:#89552b;
    font-weight:700;
}

/* QUICK LINKS */
.quick-links{
    padding:20px;
}
.btn-link{
    display:block;
    background:#6fc24f;
    color:#fff;
    padding:12px;
    border-radius:8px;
    text-align:center;
    margin-bottom:12px;
    text-decoration:none;
    font-weight:600;
    cursor: pointer;
}
.btn-link:hover{
    background:#57a63e;
}
</style>
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    <div style="flex:1">
        Dashboard
        <span id="currentSession" style="font-size:14px; margin-left:10px; font-weight:400; color:#ffeeba;"></span>
    </div>

    <!-- Edit Session Button -->
    <button onclick="window.location.href='session.html'"
        style="
            margin-left:auto;
            background:#cf6d62;
            border:none;
            padding:6px 12px;
            color:white;
            border-radius:6px;
            font-size:13px;
            cursor:pointer;
        ">
        ‚úèÔ∏è Edit Session
    </button>
</div>

<!-- OVERLAY -->
<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<!-- LEFT SLIDE MENU -->
<div id="sideMenu" class="side-menu">
    <div class="menu-item" onclick="goTo('dashboard.html')">üè† Dashboard</div>
    <div class="menu-item" onclick="goTo('index.html')">üìã Students List</div>
    <div class="menu-item" onclick="goTo('add_student.html')">‚ûï Add Student</div>
    <div class="menu-item" onclick="goTo('fees.html')">üí∞ class wise Fee</div>
    <div class="menu-item" onclick="goTo('receipt_history.html')">üìú Receipt History</div>
    <div class="menu-item" onclick="goTo('delete_student.html')">üóë Delete Students</div>
    <div class="menu-item" onclick="goTo('export.html')">üì§ Export Data</div>
</div>

<!-- DASHBOARD BOXES -->
<div class="dashboard-boxes">
    <div class="box">
        <div class="box-title">Total Students</div>
        <div id="totalStudents" class="box-value">0</div>
    </div>

    <div class="box">
        <div class="box-title">Total Classes</div>
        <div id="totalClasses" class="box-value">0</div>
    </div>

    <div class="box">
        <div class="box-title">Paid</div>
        <div id="paidCount" class="box-value">0</div>
    </div>

    <div class="box">
        <div class="box-title">Partial</div>
        <div id="partialCount" class="box-value">0</div>
    </div>

    <div class="box">
        <div class="box-title">Due</div>
        <div id="dueCount" class="box-value">0</div>
    </div>

    <div class="box">
        <div class="box-title">Total Collection</div>
        <div id="totalCollection" class="box-value">‚Çπ0</div>
    </div>

    <div class="box">
        <div class="box-title">Today's Collection</div>
        <div id="todayCollection" class="box-value">‚Çπ0</div>
    </div>
</div>

<!-- QUICK LINKS -->
<div class="quick-links">
    <a class="btn-link" onclick="backupDatabase()">‚òÅÔ∏è Backup Database to Drive</a>
    <p id="backupStatus" style="color:#007bff;font-weight:600;margin-top:10px;"></p>
</div>

<script>
const API = "https://fee-backend-ntas.onrender.com";
let session = localStorage.getItem("session") || "2024_25";
document.getElementById("currentSession").innerText = "(Session: " + session + ")";

/* LEFT SLIDE MENU */
function toggleMenu(){
    sideMenu.classList.toggle("open");
    overlay.classList.toggle("show");
}
function closeMenu(){
    sideMenu.classList.remove("open");
    overlay.classList.remove("show");
}
function goTo(p){
    closeMenu();
    window.location.href = p + "?session=" + session;
}

/* ---------------------------------------
   LOAD DASHBOARD
----------------------------------------*/
async function loadDashboard(){
    const res = await fetch(`${API}/students`, {
        headers:{ "X-Session": session }
    });

    const data = await res.json();
    if(!data.success) return;

    const students = data.students || [];

    document.getElementById("totalStudents").innerText = students.length;

    const classes = new Set(students.map(s => s.class_name));
    document.getElementById("totalClasses").innerText = classes.size;

    let paid = 0, partial = 0, due = 0;
    let totalCollection = 0, todayCollection = 0;
    const today = new Date().toISOString().split("T")[0];

    students.forEach(s => {
        const months = s.months || {};
        Object.keys(months).forEach(m => {
            const rec = months[m] || {};
            const status = rec.status || "Due";

            if(status === "Paid") paid++;
            else if(status === "Partial") partial++;
            else due++;

            totalCollection += Number(rec.paid || 0);
            if(rec.date && rec.date === today){
                todayCollection += Number(rec.paid || 0);
            }
        });
    });

    document.getElementById("paidCount").innerText = paid;
    document.getElementById("partialCount").innerText = partial;
    document.getElementById("dueCount").innerText = due;

    document.getElementById("totalCollection").innerText = "‚Çπ" + totalCollection;
    document.getElementById("todayCollection").innerText = "‚Çπ" + todayCollection;
}

loadDashboard();

/* ---------------------------------------
     ‚≠ê BACKUP FUNCTION
/* ---------------------------------------
     ‚≠ê BACKUP ALL SESSIONS FUNCTION
----------------------------------------*/
async function backupDatabase() {
    document.getElementById("backupStatus").innerText =
        "Uploading ALL session backups to Google Drive...";

    try {
        const res = await fetch(`${API}/backup/save_all_to_drive`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        });

        const result = await res.json();

        if (result.success) {
            document.getElementById("backupStatus").innerText =
                "‚úÖ All session backups uploaded successfully!";
        } else {
            document.getElementById("backupStatus").innerText =
                "‚ùå Error: " + result.message;
        }
    } catch (err) {
        document.getElementById("backupStatus").innerText =
            "‚ö†Ô∏è Failed: " + err.message;
    }
}
</script>

</body>
</html>
