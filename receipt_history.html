<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Receipt History</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#f5f5f5; }
.container { max-width: 900px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px #ccc; }
h2 { text-align:center; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #444; padding:10px; text-align:center; }
th { background:#dff0ff; }
.btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; }
.viewBtn { background:#007bff; color:white; }
.delBtn { background:#dc3545; color:white; }
.clearAll { background:red; color:white; padding:12px; width:100%; margin-top:20px; font-size:18px; }
.backBtn { background:#6c757d; color:white; padding:10px 18px; border-radius:6px; border:none; cursor:pointer; margin-bottom:15px; }
.backBtn:hover { background:#5a6268; }
</style>
</head>
<body>

<div class="container">

    <button class="backBtn" onclick="window.location.href='index.html'">⬅ Back</button>

    <h2>Receipt History</h2>

    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Class</th>
                <th>Roll</th>
                <th>Date</th>
                <th>Total Paid</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="historyTable"></tbody>
    </table>

    <button class="clearAll" onclick="clearAll()">Delete All</button>

</div>

<script>
const API = "https://fee-backend-ntas.onrender.com";

async function loadHistory() {
    try {
        const res = await fetch(`${API}/receipt/history`);
        const data = await res.json();

        if (!data.success) {
            alert("Backend error: " + data.message);
            return;
        }

        const history = data.history;
        let tb = "";

        history.forEach((r, index) => {
            tb += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${r.name}</td>
                    <td>${r.class}</td>
                    <td>${r.roll}</td>
                    <td>${r.date}</td>
                    <td>₹${r.totalPaid}</td>

                    <td>
                        <button class="btn viewBtn" onclick='viewReceipt(${JSON.stringify(r)})'>View</button>

                        <button class="btn delBtn" onclick="deleteReceipt(${r.id})">Delete</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById("historyTable").innerHTML =
            tb || `<tr><td colspan="7">No receipts saved yet.</td></tr>`;
    }
    catch (err) {
        alert("❌ Cannot load history from backend");
        console.log(err);
    }
}

loadHistory();

function viewReceipt(receipt) {
    let url = "receipt.html?data=" + encodeURIComponent(JSON.stringify(receipt));
    window.open(url, "_blank");
}

async function deleteReceipt(id) {
    if (!confirm("Delete this receipt?")) return;

    await fetch(`${API}/receipt/delete/${id}`, { method:"DELETE" });
    loadHistory();
}

async function clearAll() {
    if (!confirm("Delete ALL receipts?")) return;

    await fetch(`${API}/receipt/delete_all`, { method:"DELETE" });
    loadHistory();
}
</script>

</body>
</html>
