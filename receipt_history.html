<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Receipt History</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f5f5f5;
}
.container {
    max-width: 1000px;
    margin: auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px #ccc;
}
h2 { text-align: center; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; }
th, td {
    border: 1px solid #444;
    padding: 8px;
    text-align: center;
    font-size: 14px;
}
th { background: #dff0ff; }

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
}
.viewBtn { background: #007bff; color: #fff; }
.delBtn { background: #dc3545; color: #fff; }

.clearAll {
    background: red;
    color: white;
    padding: 12px;
    width: 100%;
    margin-top: 20px;
    font-size: 18px;
}

.backBtn {
    background: #6c757d;
    color: white;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin-bottom: 15px;
}
.sessionBox { margin-bottom:20px; font-size:17px; }
select { padding:8px; font-size:16px; border-radius:6px; }
</style>
</head>

<body>

<div class="container">

    <button class="backBtn" onclick="window.location.href='index.html'">⬅ Back</button>

    <h2>Receipt History</h2>

    <div class="sessionBox">
        <strong>Select Session:</strong>
        <select id="sessionSelect" onchange="loadHistory()"></select>
    </div>

    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Receipt No</th>
                <th>Name</th>
                <th>Father</th>
                <th>Class</th>
                <th>Roll</th>
                <th>Date</th>
                <th>Total Paid</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="historyTable"></tbody>
    </table>

    <button class="clearAll" onclick="clearAll()">Delete All</button>

</div>

<script>
const API = "http://pserp.pythonanywhere.com";

/* ---------------- LOAD SESSIONS ---------------- */
async function loadSessions() {
    const res = await fetch(`${API}/session/list`);
    const data = await res.json();

    let sel = document.getElementById("sessionSelect");
    sel.innerHTML = "";

    data.sessions.forEach(s => {
        let opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
    });

    sel.value = localStorage.getItem("session") || data.sessions[0];
    loadHistory();
}
loadSessions();

/* ---------------- LOAD HISTORY ---------------- */
async function loadHistory() {
    const s = document.getElementById("sessionSelect").value;
    localStorage.setItem("session", s);

    const res = await fetch(`${API}/receipt/history`, {
        headers: { "X-Session": s }
    });

    const data = await res.json();
    if (!data.success) {
        alert("Error loading history");
        return;
    }

    const rows = data.history;
    let tb = "";

    rows.forEach((r, i) => {

        const finalClass = r.class_name || r.class || "-";
        const totalPaid = r.total_paid ?? r.totalPaid ?? 0;

        const encoded = encodeURIComponent(JSON.stringify(r));

        tb += `
        <tr>
            <td>${i + 1}</td>
            <td>${r.receipt_number || "-"}</td>
            <td>${r.name}</td>
            <td>${r.father}</td>
            <td>${finalClass}</td>
            <td>${r.roll}</td>
            <td>${r.date}</td>
            <td>₹${totalPaid}</td>

            <td>
                <button class="btn viewBtn" onclick='viewReceipt("${encoded}")'>View</button>
                <button class="btn delBtn" onclick="deleteReceipt('${r.id}')">Delete</button>
            </td>
        </tr>`;
    });

    document.getElementById("historyTable").innerHTML =
        tb || `<tr><td colspan="9">No receipts found.</td></tr>`;
}

/* ---------------- DELETE ONE ---------------- */
async function deleteReceipt(id) {
    if (!confirm("Delete this receipt?")) return;

    const s = document.getElementById("sessionSelect").value;

    await fetch(`${API}/receipt/delete/${id}`, {
        method: "DELETE",
        headers: { "X-Session": s }
    });

    loadHistory();
}

/* ---------------- DELETE ALL ---------------- */
async function clearAll() {
    if (!confirm("Delete ALL receipts?")) return;

    const s = document.getElementById("sessionSelect").value;

    await fetch(`${API}/receipt/delete_all`, {
        method: "DELETE",
        headers: { "X-Session": s }
    });

    loadHistory();
}

/* ---------------- VIEW RECEIPT ---------------- */
function viewReceipt(encoded) {
    const obj = JSON.parse(decodeURIComponent(encoded));
    window.open("receipt.html?data=" + encodeURIComponent(JSON.stringify(obj)), "_blank");
}
</script>

</body>
</html>
