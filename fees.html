<!DOCTYPE html>
<html>
<head>
<title>Edit Fee Structure</title>

<style>
body{
    font-family:Poppins, sans-serif;
    background:#f4f6f9;
    margin:0;
    padding:0;
}

/* TOP BAR */
.topbar{
    width:100%;
    padding:15px 20px;
    background:#007bff;
    color:#fff;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:15px;
    box-sizing:border-box;
    position:sticky;
    top:0;
    z-index:3000;
    font-size:20px;
    font-weight:600;
}

#sessionSelect{
    margin-left:auto;
    padding:6px 10px;
    border-radius:6px;
    border:none;
    font-size:15px;
}

.menu-btn{
    font-size:28px;
    cursor:pointer;
    font-weight:900;
    user-select:none;
}

.overlay{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.35);
    display:none;
    z-index:1400;
}
.overlay.show{ display:block; }

.side-menu{
    position:fixed;
    top:0;
    left:-280px;
    width:260px;
    height:100%;
    background:#fff;
    box-shadow:2px 0 8px rgba(0,0,0,.15);
    padding:20px;
    transition:left 0.35s cubic-bezier(0.25, 1, 0.5, 1);
    z-index:2000;
    border-radius:0 18px 18px 0;
}
.side-menu.open{ left:0; }

.menu-item{
    padding:12px 0;
    border-bottom:1px solid #eee;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
}
.menu-item:hover{ color:#007bff; }

.container{
    max-width:800px;
    margin:auto;
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,.1);
    margin-top:20px;
}

table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border:1px solid #ddd;padding:10px;text-align:center}
th{background:#007bff;color:white}
input{padding:6px;width:120px}
button{padding:6px 12px;background:#28a745;color:white;border:none;border-radius:5px;cursor:pointer}
</style>
</head>

<body>

<div class="topbar">
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    Edit Fee Structure
    <select id="sessionSelect" onchange="changeSession()"></select>
</div>

<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<div id="sideMenu" class="side-menu">
    <div class="menu-item" onclick="goTo('fees.html')">üí∞ Fees Modify</div>
    <div class="menu-item" onclick="goTo('index.html')">üìã Students</div>
    <div class="menu-item" onclick="goTo('dashboard.html')">üè† Dashboard</div>
    <div class="menu-item" onclick="goTo('add_student.html')">‚ûï Add Student</div>
    <div class="menu-item" onclick="goTo('receipt_history.html')">üìú Receipt History</div>
    <div class="menu-item" onclick="goTo('delete_student.html')">üóë Delete Students</div>
    <div class="menu-item" onclick="goToPage('export.html')">üì§ Export Data</div>
</div>

<script>
const API = "http://pserp.pythonanywhere.com";
let currentSession = localStorage.getItem("session") || "2024_25";

function toggleMenu(){
    document.getElementById("sideMenu").classList.add("open");
    document.getElementById("overlay").classList.add("show");
}
function closeMenu(){
    document.getElementById("sideMenu").classList.remove("open");
    document.getElementById("overlay").classList.remove("show");
}
function goTo(x){ location.href=x; }

/* LOAD SESSIONS */
async function loadSessions(){
    try {
        const res = await fetch(API + "/session/list");
        const data = await res.json();

        let sel = document.getElementById("sessionSelect");
        sel.innerHTML = "";

        data.sessions.forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });

        if(!data.sessions.includes(currentSession)){
            currentSession = data.sessions[0];
        }

        sel.value = currentSession;
        localStorage.setItem("session", currentSession);
    }
    catch(err){
        alert("Error loading sessions!");
    }
}

function changeSession(){
    currentSession = document.getElementById("sessionSelect").value;
    localStorage.setItem("session", currentSession);
    loadFees();
}

/* LOAD FEES */
async function loadFees(){
    const res = await fetch(`${API}/fees/get`, {
        headers: { "X-Session": currentSession }
    });

    const data = await res.json();
    if (!data.success) return alert("Error loading fees");

    const body = document.getElementById("feeBody");
    body.innerHTML = "";

    data.fees.forEach(f => {
        let monthly = f.monthly_fee ?? 0;
        let annual = f.annual_charge ?? 0;

        body.innerHTML += `
          <tr>
            <td>${f.class_name}</td>

            <td><input id="fee_${f.class_name}" 
                       value="${monthly}" 
                       type="number"></td>

            <td><input id="annual_${f.class_name}" 
                       value="${annual}" 
                       type="number"></td>

            <td><button onclick="saveFee('${f.class_name}')">Save</button></td>
          </tr>
        `;
    });
}

/* SAVE FEES */
async function saveFee(className){
    const monthly_fee = Number(document.getElementById("fee_" + className).value);
    const annual_charge = Number(document.getElementById("annual_" + className).value);

    const res = await fetch(`${API}/fees/update`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "X-Session": currentSession
        },
        body: JSON.stringify({
            class_name: className,   // FIXED üî•
            monthly_fee,
            annual_charge
        })
    });

    const data = await res.json();
    alert(data.message ?? "Saved!");
}


/* INIT */
loadSessions().then(loadFees);
</script>

<div class="container">

  <button onclick="location.href='index.html?session='+currentSession" 
        style="padding:8px 14px;background:#007bff;color:white;border:none;border-radius:6px;cursor:pointer;margin-bottom:12px">
        ‚¨Ö Back to Home
  </button>

  <h2>Class-wise Fee Structure</h2>

  <table>
    <thead>
      <tr>
        <th>Class</th>
        <th>Monthly Fee (‚Çπ)</th>
        <th>Annual Charge (‚Çπ)</th>
        <th>Save</th>
      </tr>
    </thead>

    <tbody id="feeBody"></tbody>

  </table>
</div>

</body>
</html>
