<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Import Students</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:20px}
.container{max-width:700px;margin:auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
button,input,select{display:block;width:100%;padding:10px;margin-top:10px;border-radius:8px}
.import{background:#6f42c1;color:#fff;border:none}
.download{background:#ff9800;color:#fff;border:none}
</style>
</head>

<body>
<div class="container">
  <h2>Import Students From Excel</h2>

  <label>Select Session</label>
  <select id="sessionSelect"></select>

  <p>Required headers: <strong>Name, Father, Class, Roll, PreviousDue, AnnualCharge(optional)</strong></p>

  <input type="file" id="file" accept=".xlsx,.xls" />

  <button class="import" onclick="importExcel()">Import to Backend</button>
  <button class="download" onclick="downloadSample()">Download Sample</button>
  <button onclick="location.href='index.html'">⬅ Back</button>

  <p id="status"></p>
</div>

<script>
const API = "http://127.0.0.1:5000";
let currentSession = localStorage.getItem("session") || "2024_25";

/* ------------------------------------
   LOAD SESSION LIST
------------------------------------ */
async function loadSessions(){
    try {
        const res = await fetch(API + "/session/list");
        const data = await res.json();

        const sel = document.getElementById("sessionSelect");
        sel.innerHTML = "";

        data.sessions.forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });

        sel.value = currentSession;
        sel.onchange = () => {
            currentSession = sel.value;
            localStorage.setItem("session", currentSession);
        };
    }
    catch(err){
        alert("❌ Failed to load sessions");
    }
}
loadSessions();


/* ------------------------------------
   NORMALIZE CLASS FORMAT
------------------------------------ */
function normalizeClassKey(raw){
  if(!raw) return "";
  const key = String(raw).trim().replace(/\s+/g,"").toLowerCase();

  const map = {
    "nursery":"Nursery","lkg":"LKG","ukg":"UKG",
    "1":"1st","1st":"1st","2":"2nd","2nd":"2nd","3":"3rd","3rd":"3rd",
    "4":"4th","4th":"4th","5":"5th","5th":"5th",
    "6":"6th","6th":"6th","7":"7th","7th":"7th",
    "8":"8th","8th":"8th","9":"9th","9th":"9th",
    "10":"10th","10th":"10th",
    "11medical":"11th_Medical","11thmedical":"11th_Medical",
    "11commerce":"11th_Commerce","11thcommerce":"11th_Commerce",
    "11art":"11th_Art","11thart":"11th_Art",
    "12medical":"12th_Medical","12thmedical":"12th_Medical",
    "12commerce":"12th_Commerce","12thcommerce":"12th_Commerce",
    "12art":"12th_Art","12thart":"12th_Art"
  };

  return map[key] || raw;
}


/* ------------------------------------
   DOWNLOAD SAMPLE EXCEL
------------------------------------ */
function downloadSample(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet([
    {
      Name:"Rahul Sharma",
      Father:"Suresh Kumar",
      Class:"6th",
      Roll:1,
      PreviousDue:200,
      AnnualCharge:500   // OPTIONAL
    }
  ]);
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  XLSX.writeFile(wb, "student_format.xlsx");
}


/* ------------------------------------
   IMPORT EXCEL AND SEND TO BACKEND
------------------------------------ */
async function importExcel(){
  const file = document.getElementById("file").files[0];
  if(!file){ alert("Please select a file"); return; }

  const reader = new FileReader();

  reader.onload = async function(e){
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type:"array" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws);

    let imported = 0, skipped = 0;

    for(const row of rows){
      const name = row.Name;
      const father = row.Father || "";
      const clsRaw = row.Class;
      const roll = row.Roll;
      const previousDue = Number(row.PreviousDue || 0);
      const annualCharge = Number(row.AnnualCharge || 0);

      if(!name || !clsRaw || !roll){
        skipped++;
        continue;
      }

      const class_name = normalizeClassKey(clsRaw);

      // Build months JSON
      const months = {};

      const monthly_fee_res = await fetch(`${API}/fees/get`, {
        headers: { "X-Session": currentSession }
      });
      const feeData = await monthly_fee_res.json();

      const feeRow = feeData.fees.find(x => x.class_name === class_name);
      const monthlyFee = feeRow ? Number(feeRow.monthly_fee) : 0;

      ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
      .forEach(m=>{
        months[m] = {
          paid: 0,
          due: monthlyFee,
          status: "Due",
          date: "",
          purpose: "Monthly Fee",
          extra: 0
        };
      });

      months["previousDue"] = {
        paid: 0,
        due: previousDue,
        status: previousDue > 0 ? "Due" : "OK",
        date: "",
        purpose: "Previous Dues",
        extra: 0
      };

      months["Annual"] = {
        paid: 0,
        due: annualCharge,
        status: annualCharge > 0 ? "Due" : "OK",
        date: "",
        purpose: "Annual Charge",
        extra: 0
      };

      // SEND TO BACKEND
      const res = await fetch(`${API}/student/add`, {
        method: "POST",
        headers: {
            "Content-Type":"application/json",
            "X-Session": currentSession
        },
        body: JSON.stringify({
          name,
          father,
          class_name,
          roll: String(roll),
          previous_due: previousDue,
          annual_charge: annualCharge,
          advance: 0,
          months
        })
      });

      const json = await res.json();
      if(json.success) imported++;
      else skipped++;
    }

    alert(`Imported: ${imported}\nSkipped: ${skipped}`);
    location.href = `index.html?session=${currentSession}`;
  };

  reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
