<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Student Details</title>

<style>
body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:20px}
.container{max-width:1500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.info{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.card{background:#f7f7f7;padding:10px;border-radius:8px;min-width:140px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#007bff;color:#fff}
.paid{background:#c8ffc8;color:#0b7a0b;font-weight:700}
.partial{background:#fff3bf;color:#7a5a00;font-weight:700}
.due{background:#ffd2d2;color:#b30000;font-weight:700}
.btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;margin:2px}
.paid-btn{background:#28a745;color:#fff}
.due-btn{background:#dc3545;color:#fff}
.action-bar{display:flex;align-items:center;gap:12px;margin:15px 0;flex-wrap:wrap}
.amount-box{display:flex;flex-direction:column}
.amount-box input{padding:8px 10px;border-radius:6px;border:1px solid #bbb;width:160px}
.btn.primary{background:#0d6efd;color:#fff}
.btn.advance{background:#198754;color:#fff}
.btn.back{background:#6c757d;color:#fff}
.input-small{width:100px;padding:6px;border-radius:6px;border:1px solid #ccc}
</style>
</head>

<body>
<div class="container">
  <h2>Student Fee Details</h2>

  <div class="info">
    <div class="card">Name<br><strong id="nm"></strong></div>
    <div class="card">Father<br><strong id="fa"></strong></div>
    <div class="card">Class<br><strong id="cl"></strong></div>
    <div class="card">Roll<br><strong id="rl"></strong></div>
    <div class="card">Advance (â‚¹)<br><strong id="adv">0</strong></div>
  </div>

  <div class="action-bar">
      <div class="amount-box">
        <label>Enter amount submitted:</label>
        <input id="payAmount" type="number" placeholder="Enter amount"/>
      </div>

      <button class="btn primary" onclick="submitPayment()">ðŸ’³ Submit Payment</button>
      <button class="btn back" onclick="location.href='index.html'">â¬… Back</button>
      <button class="btn paid-btn" onclick="generateReceipt()">ðŸ§¾ Generate Receipt</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Purpose</th>
        <th>Extra (â‚¹)</th>
        <th>Status</th>
        <th>Paid (â‚¹)</th>
        <th>Due (â‚¹)</th>
        <th>Payment Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>

    <tfoot>
      <tr>
        <td colspan="4">Totals</td>
        <td id="totalPaid">â‚¹0</td>
        <td id="totalDue">â‚¹0</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>

</div>

<script>
const API = "https://fee-backend-ntas.onrender.com";

// URL Params
const params = new URLSearchParams(window.location.search);
const rollParam = params.get("roll");
const classParam = params.get("class");

// Student object
let student = null;

// ---------------------- Load student from backend ----------------------
async function loadStudent() {
  try {
    const res = await fetch(`${API}/student/${classParam}/${rollParam}`);
    const data = await res.json();

    if (!data.success) {
      alert("Student not found");
      return;
    }

    student = data.student;

    // Fix naming
    student.name = student.name;
    student.father = student.father;
    student.class_name = student.class_name;
    student.roll = student.roll;
    student.previous_due = student.previous_due;
    student.months = student.months || {};
    student.advance = student.advance || 0;

    initializeStudentData();
    render();
  }
  catch (err) {
    alert("âŒ Cannot connect to backend!");
  }
}

loadStudent();

// ---------------------- Month Setup ----------------------
const monthsList = [
  "previousDue","Jan","Feb","Mar","Apr","May","Jun",
  "Jul","Aug","Sep","Oct","Nov","Dec"
];

let monthlyFees = {};  // backend loaded fees

async function loadFees() {
  try {
    const res = await fetch(`${API}/fees/get`);
    const data = await res.json();

    if (data.success) {
      monthlyFees = {};
      data.fees.forEach(f => {
        monthlyFees[f.class_name] = f.monthly_fee;
      });
    }
  } catch (e) {
    alert("Failed to load fee structure from backend");
  }
}

// FIXED â€” proper async loader
(async () => {
    await loadFees();
    await loadStudent();
})();



function getFeeForClass(c){ return monthlyFees[c] || 0; }

// ---------------------- Prepare month data ----------------------
function initializeStudentData(){
  const fee = getFeeForClass(student.class_name);
  const previousDue = Number(student.previous_due || 0);

  monthsList.forEach(m => {
    if (!student.months[m]) {
      student.months[m] = {
        paid: 0,
        due: m==="previousDue" ? previousDue : fee,
        status: "Due",
        date: "",
        purpose: "",
        extra: 0
      };
    }
  });

  document.getElementById("nm").textContent = student.name;
  document.getElementById("fa").textContent = student.father;
  document.getElementById("cl").textContent = student.class_name;
  document.getElementById("rl").textContent = student.roll;
  document.getElementById("adv").textContent = student.advance;
}

// ---------------------- Save to backend ----------------------
async function saveToBackend() {

  const payload = {
    class: student.class_name,
    roll: student.roll,
    student: {
      name: student.name,
      father: student.father,
      class_name: student.class_name,
      roll: student.roll,
      previous_due: student.previous_due,
      months: student.months,
      advance: student.advance
    }
  };

  console.log("Sending:", payload);

  const res = await fetch(`${API}/update_student`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  console.log("Response:", data);

  if (!data.success) {
    alert("âŒ Error saving to backend: " + data.message);
  }
}

// ---------------------- Render Table ----------------------
function render(){
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  let totalPaid=0, totalDue=0;

  monthsList.forEach((m, idx) => {
    const rec = student.months[m];

    const displayedPaid = Number(rec.paid) + Number(rec.extra);

    const statusClass = rec.status === "Paid"
      ? "paid"
      : rec.status === "Partial"
      ? "partial"
      : "due";

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${m==="previousDue"?"Previous Dues":m}</td>
      <td><input class="input-small" value="${rec.purpose}" onchange="updatePurpose('${m}', this.value)"></td>
      <td><input class="input-small" type="number" value="${rec.extra}" onchange="updateExtra('${m}', this.value)"></td>
      <td class="${statusClass}">${rec.status}</td>
      <td>â‚¹${displayedPaid}</td>
      <td>â‚¹${rec.due}</td>
      <td>${rec.date}</td>
      <td>
         <button class="btn paid-btn" onclick="markPaid('${m}')">Mark Paid</button>
         <button class="btn due-btn" onclick="markDue('${m}')">Mark Due</button>
      </td>
    `;

    tbody.appendChild(tr);

    totalPaid += displayedPaid;
    totalDue += rec.due;
  });

  document.getElementById("totalPaid").textContent="â‚¹"+totalPaid;
  document.getElementById("totalDue").textContent="â‚¹"+totalDue;
}

// ---------------------- Purpose Update ----------------------
function updatePurpose(m,val){
  student.months[m].purpose = val;
  saveToBackend();
}

// ---------------------- Extra Update ----------------------
function updateExtra(m,val){
  student.months[m].extra = Number(val);
  saveToBackend();
  render();
}

// ---------------------- Submit Payment ----------------------
function submitPayment(){
  let amt = Number(document.getElementById("payAmount").value || 0);
  if (!amt){ alert("Enter amount"); return; }

  if (student.advance > 0){
    amt += student.advance;
    student.advance = 0;
  }

  for (let i=0; i<monthsList.length && amt>0; i++){
    const key = monthsList[i];
    const rec = student.months[key];

    if (rec.due > 0){
      const pay = Math.min(rec.due, amt);
      rec.paid += pay;
      rec.due -= pay;
      rec.status = rec.due === 0 ? "Paid" : "Partial";
      rec.date = new Date().toISOString().split("T")[0];
      amt -= pay;
    }
  }

  if (amt > 0) student.advance = amt;

  document.getElementById("payAmount").value = "";
  saveToBackend();
  render();
}

// ---------------------- Mark Paid ----------------------
function markPaid(m){
  const rec = student.months[m];
  rec.paid += rec.due;
  rec.due = 0;
  rec.status = "Paid";
  rec.date = new Date().toISOString().split("T")[0];

  saveToBackend();
  render();
}

// ---------------------- Mark Due ----------------------
function markDue(m){
  const feeNow = m==="previousDue"
        ? Number(student.previous_due)
        : getFeeForClass(student.class_name);

  const rec = student.months[m];
  rec.paid = 0;
  rec.due = feeNow;
  rec.status = "Due";
  rec.date = "";

  saveToBackend();
  render();
}

// ---------------------- Generate Receipt ----------------------
function generateReceipt(){
  const data = { 
    student_id: student.id,        // ADD THIS LINE âœ”
    name: student.name, 
    father: student.father, 
    class: student.class_name, 
    roll: student.roll,
    advance: student.advance,
    date: new Date().toLocaleDateString('en-IN'),
    months: []
  };

  let tP=0, tD=0;

  monthsList.forEach(m=>{
    const rec = student.months[m];
    const displayedPaid = rec.paid + rec.extra;

    data.months.push({
      month: m==="previousDue" ? "Previous Dues" : m,
      purpose: rec.purpose,
      extra: rec.extra,
      paid: rec.paid,
      displayedPaid,
      due: rec.due,
      status: rec.status
    });

    tP += displayedPaid;
    tD += rec.due;
  });

  data.totalPaid = tP;
  data.totalDue = tD;

  window.open("receipt.html?data="+encodeURIComponent(JSON.stringify(data)), "_blank");
}

</script>

</body>
</html>
