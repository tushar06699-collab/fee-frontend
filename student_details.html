<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Student Details</title>

<style>
body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:20px}
.container{max-width:1500px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.info{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.card{background:#f7f7f7;padding:10px;border-radius:8px;min-width:140px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#007bff;color:#fff}
.paid{background:#c8ffc8;color:#0b7a0b;font-weight:700}
.partial{background:#fff3bf;color:#7a5a00;font-weight:700}
.due{background:#ffd2d2;color:#b30000;font-weight:700}
.btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;margin:2px}
.paid-btn{background:#28a745;color:#fff}
.due-btn{background:#dc3545;color:#fff}
.action-bar{display:flex;align-items:center;gap:12px;margin:15px 0;flex-wrap:wrap}
.amount-box{display:flex;flex-direction:column}
.amount-box input{padding:8px 10px;border-radius:6px;border:1px solid #bbb;width:160px}
.btn.primary{background:#0d6efd;color:#fff}
.btn.advance{background:#198754;color:#fff}
.btn.back{background:#6c757d;color:#fff}
.input-small{width:100px;padding:6px;border-radius:6px;border:1px solid #ccc}
</style>
</head>

<body>
<div class="container">
  <h2>Student Fee Details</h2>

  <div class="info">
    <div class="card">Name<br><strong id="nm"></strong></div>
    <div class="card">Father<br><strong id="fa"></strong></div>
    <div class="card">Class<br><strong id="cl"></strong></div>
    <div class="card">Roll<br><strong id="rl"></strong></div>
    <div class="card">Advance (â‚¹)<br><strong id="adv">0</strong></div>
  </div>

  <div class="action-bar">
      <div class="amount-box">
        <label>Enter amount submitted:</label>
        <input id="payAmount" type="number" placeholder="Enter amount"/>
      </div>

      <button class="btn primary" onclick="submitPayment()">ðŸ’³ Submit Payment</button>
      <button class="btn advance" onclick="applyAdvance()">Apply Advance</button>

      <button class="btn back" onclick="history.back()">â¬… Back</button>
      <button class="btn paid-btn" onclick="generateReceipt()">ðŸ§¾ Generate Receipt</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Month</th>
        <th>Purpose</th>
        <th>Extra (â‚¹)</th>
        <th>Status</th>
        <th>Paid (â‚¹)</th>
        <th>Due (â‚¹)</th>
        <th>Payment Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>

    <tfoot>
      <tr>
        <td colspan="4">Totals</td>
        <td id="totalPaid">â‚¹0</td>
        <td id="totalDue">â‚¹0</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>

</div>

<script>
const API = "http://pserp.pythonanywhere.com";

// ---------------- PARAMS ----------------
const params = new URLSearchParams(window.location.search);
const rollParam = params.get("roll");
const classParam = params.get("class");
const sessionParam = params.get("session") || "2024_25";

let student = null;

// months order: previousDue, Annual, Jan..Dec (Annual placed between previousDue and Jan)
const monthsList = [
  "previousDue","Annual","Apr","May","Jun",
  "Jul","Aug","Sep","Oct","Nov","Dec","Jan","Feb","Mar"
];

let monthlyFees = {};   // class_name -> monthly_fee
let annualFees = {};    // class_name -> annual_fee (Option A: fixed per class)

/* Utility: safe number */
function cleanNumber(x){
  return isNaN(Number(x)) ? 0 : Number(x);
}

/* ---------------- LOAD FEES ----------------
   We expect backend `fees/get` to return items with:
   { class_name, monthly_fee, (optional) annual_fee | annual_charge }
   If annual isn't provided, fallback to 0.
*/
async function loadFees(){
  try{
    const res = await fetch(`${API}/fees/get`, { headers: { "X-Session": sessionParam } });
    const data = await res.json();
    if(!data.success){
      console.warn("fees/get responded with success=false", data);
      return;
    }

    monthlyFees = {};
    annualFees = {};

    data.fees.forEach(f => {
      const cls = f.class_name;
      monthlyFees[cls] = cleanNumber(f.monthly_fee || 0);
      // Support multiple possible field names from different backends:
      annualFees[cls] = cleanNumber(f.annual_fee || f.annual_charge || 0);
    });
  } catch(e){
    console.error("Failed to load fees:", e);
    alert("âŒ Cannot load fees from backend");
  }
}

function getMonthlyFeeForClass(c){ return monthlyFees[c] || 0; }
function getAnnualFeeForClass(c){ return annualFees[c] || 0; }

/* ---------------- LOAD STUDENT ----------------
   Uses endpoint: GET /student/:class/:roll
   Sends ?session=... and also backend expects X-Session header in other calls.
*/
async function loadStudent(){
  try{
    const url = `${API}/student/${encodeURIComponent(classParam)}/${encodeURIComponent(rollParam)}?session=${encodeURIComponent(sessionParam)}`;
    const res = await fetch(url, { headers: { "X-Session": sessionParam } });
    const data = await res.json();
    if(!data.success){
      alert("Student not found");
      return;
    }

    student = data.student || {};
    // ensure numeric fields
    student.previous_due = cleanNumber(student.previous_due);
    student.advance = cleanNumber(student.advance);

    // ensure months object exists
    if(!student.months || typeof student.months !== "object"){
      student.months = {};
    }

    initializeStudentData();
    render();
  } catch(err){
    console.error("loadStudent error:", err);
    alert("âŒ Cannot connect to backend!");
  }
}

/* ---------------- INITIALIZE MONTHS ----------------
   Fill missing months with sensible defaults:
     - previousDue: student.previous_due
     - Annual: annual fee for student's class (Option A)
     - months Jan..Dec: monthly fee for class
*/
function initializeStudentData(){
  const fee = getMonthlyFeeForClass(student.class_name);
  const annual = getAnnualFeeForClass(student.class_name);
  const previousDue = cleanNumber(student.previous_due);

  monthsList.forEach(m => {
    if (!student.months[m] || typeof student.months[m] !== "object") {
      // create default record
      let dueDefault = 0;
      if (m === "previousDue") {
    // do NOT add monthly or annual again
    dueDefault = previousDue;
} 
else if (m === "Annual") {
    // Annual should be 0 in new session unless explicitly set
    dueDefault = 0;
} 
else {
    // Monthly fee should be the new session's fee
    dueDefault = fee;
}

      student.months[m] = {
        paid: 0,
        due: dueDefault,
        status: dueDefault === 0 ? "Paid" : "Due",
        date: "",
        purpose: m === "Annual" ? "Annual Charge" : (m === "previousDue" ? "Previous Dues" : "Monthly Fee"),
        extra: 0
      };
    } else {
      // sanitize existing record
      student.months[m].paid = cleanNumber(student.months[m].paid);
      student.months[m].due = cleanNumber(student.months[m].due);
      student.months[m].extra = cleanNumber(student.months[m].extra);
      student.months[m].purpose = student.months[m].purpose || (m === "Annual" ? "Annual Charge" : (m === "previousDue" ? "Previous Dues" : "Monthly Fee"));
      student.months[m].status = student.months[m].status || (student.months[m].due === 0 ? "Paid" : "Due");
      student.months[m].date = student.months[m].date || "";
      // If due was 0 but fee exists, set default due only if user never set value
      if (m !== "previousDue" && m !== "Annual" && student.months[m].due === 0 && fee > 0 && student.months[m].paid === 0) {
        student.months[m].due = fee;
        student.months[m].status = "Due";
      }
      if (m === "Annual" && student.months[m].due === 0 && annual > 0 && student.months[m].paid === 0) {
        student.months[m].due = annual;
        student.months[m].status = "Due";
      }
    }
  });

  // top cards
  document.getElementById("nm").textContent = student.name || "";
  document.getElementById("fa").textContent = student.father || "";
  document.getElementById("cl").textContent = student.class_name || classParam || "";
  document.getElementById("rl").textContent = student.roll || rollParam || "";
  document.getElementById("adv").textContent = student.advance || 0;
}

/* ---------------- SAVE ----------------
   Save entire student object back to backend
*/
async function saveToBackend(){
  if(!student) return;
  const payload = {
    class: student.class_name,
    roll: student.roll,
    student: student
  };

  try {
    const res = await fetch(`${API}/update_student`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Session": sessionParam },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.success){
      console.warn("Save returned success=false:", data);
    }
    return data;
  } catch(e){
    console.error("saveToBackend error:", e);
    alert("âŒ Failed to save to backend");
    return null;
  }
}

/* ---------------- RENDER TABLE ---------------- */
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  let totalPaid = 0, totalDue = 0;

  monthsList.forEach(m => {
    const rec = student.months[m];

    // ensure rec exists (defensive)
    if(!rec) {
      student.months[m] = { paid:0, due:0, extra:0, purpose: (m==="Annual"?"Annual Charge":(m==="previousDue"?"Previous Dues":"Monthly Fee")), status: "Due", date: "" };
    }

    const displayedPaid = cleanNumber(rec.paid) + cleanNumber(rec.extra);

    const statusClass =
      rec.status === "Paid" ? "paid" :
      rec.status === "Partial" ? "partial" : "due";

    const label = (m==="previousDue") ? "Previous Dues" : m;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${label}</td>
      <td><input class="input-small" value="${rec.purpose || ""}" onchange="updatePurpose('${m}', this.value)"></td>
      <td><input class="input-small" type="number" value="${rec.extra || 0}" onchange="updateExtra('${m}', this.value)"></td>
      <td class="${statusClass}">${rec.status}</td>
      <td>â‚¹${displayedPaid}</td>
      <td>â‚¹${rec.due}</td>
      <td>${rec.date || ""}</td>
      <td>
         <button class="btn paid-btn" onclick="markPaid('${m}')">Mark Paid</button>
         <button class="btn due-btn" onclick="markDue('${m}')">Mark Due</button>
      </td>
    `;
    tbody.appendChild(tr);

    totalPaid += displayedPaid;
    totalDue += rec.due;
  });

  document.getElementById("totalPaid").textContent = "â‚¹" + totalPaid;
  document.getElementById("totalDue").textContent = "â‚¹" + totalDue;
}

/* ---------------- UPDATE PURPOSE/EXTRA ---------------- */
function updatePurpose(m, val){
  student.months[m].purpose = val;
  saveToBackend();
}
function updateExtra(m, val){
  student.months[m].extra = cleanNumber(val);
  saveToBackend();
  render();
}

/* ---------------- APPLY ADVANCE ----------------
   Applies student.advance across months in the monthsList order.
*/
async function applyAdvance(){
  if(!student) { alert("Student not loaded"); return; }
  let adv = cleanNumber(student.advance);
  if(adv <= 0){ alert("No advance available."); return; }

  // apply in monthsList order (previousDue -> Annual -> Jan..Dec)
  for(let m of monthsList){
    if(adv <= 0) break;
    const rec = student.months[m];
    if(!rec) continue;
    let due = cleanNumber(rec.due || 0);
    if(due <= 0) continue;
    const pay = Math.min(due, adv);
    rec.paid = cleanNumber(rec.paid || 0) + pay;
    rec.due = due - pay;
    rec.status = rec.due === 0 ? "Paid" : (rec.paid > 0 ? "Partial" : "Due");
    rec.date = new Date().toISOString().split("T")[0];
    adv -= pay;
  }

  student.advance = adv;
  await saveToBackend();
  render();
  alert("Advance applied.");
}

/* ---------------- PAYMENT LOGIC ----------------
   Submit a raw payment amount: uses advance if present (keeps your previous behavior)
*/
async function submitPayment(){
  let amt = cleanNumber(document.getElementById("payAmount").value);
  if(!amt){ alert("Enter amount"); return; }

  // If student had advance, add it to amt (previous behavior) and zero student's advance
  if(student.advance && student.advance > 0){
    amt += cleanNumber(student.advance);
    student.advance = 0;
  }

  // pay in monthsList order
  for(let i=0; i<monthsList.length && amt>0; i++){
    const key = monthsList[i];
    const rec = student.months[key];
    if(!rec) continue;
    if(rec.due > 0){
      const pay = Math.min(rec.due, amt);
      rec.paid = cleanNumber(rec.paid || 0) + pay;
      rec.due = cleanNumber(rec.due || 0) - pay;
      rec.status = rec.due === 0 ? "Paid" : "Partial";
      rec.date = new Date().toISOString().split("T")[0];
      amt -= pay;
    }
  }

  if(amt > 0){
    // leftover becomes advance
    student.advance = (student.advance || 0) + amt;
  }

  document.getElementById("payAmount").value = "";
  await saveToBackend();
  render();
}

/* ---------------- MARK PAID / DUE ---------------- */
async function markPaid(m){
  const rec = student.months[m];
  if(!rec) return;
  rec.paid = cleanNumber(rec.paid || 0) + cleanNumber(rec.due || 0);
  rec.due = 0;
  rec.status = "Paid";
  rec.date = new Date().toISOString().split("T")[0];
  await saveToBackend();
  render();

  localStorage.setItem("paymentMade", Date.now());

   alert("Payment Successful!");
}

async function markDue(m){
  const rec = student.months[m];
  if(!rec) return;
  let feeNow;
  if(m === "previousDue") feeNow = cleanNumber(student.previous_due || 0);
  else if(m === "Annual") feeNow = getAnnualFeeForClass(student.class_name);
  else feeNow = getMonthlyFeeForClass(student.class_name);

  rec.paid = 0;
  rec.due = feeNow;
  rec.status = feeNow === 0 ? "Paid" : "Due";
  rec.date = "";
  await saveToBackend();
  render();
}

/* ---------------- GENERATE RECEIPT (simple open ) ---------------- */
function generateReceipt() {

    let finalMonths = [];

    monthsList.forEach(m => {
        const rec = student.months[m];
        if (!rec) return;

        finalMonths.push({
            month: m === "previousDue" ? "Previous Due" : m,
            paid: rec.paid || 0,
            due: rec.due || 0,
            status: rec.status || "Due",
            purpose: rec.purpose || "",
            extra: rec.extra || 0
        });
    });

    const data = {
        name: student.name,
        father: student.father,
        class: student.class_name,
        roll: student.roll,
        date: new Date().toLocaleDateString(),

        totalPaid: finalMonths.reduce((a, m) => a + m.paid, 0),
        totalDue: finalMonths.reduce((a, m) => a + m.due, 0),
        advance: student.advance || 0,

        months: finalMonths,

        session: sessionParam
    };

    const link = "receipt.html?data=" + encodeURIComponent(JSON.stringify(data));
    window.location.href = link;
}

window.addEventListener("focus", () => {
    const flag = localStorage.getItem("paymentMade");
    if (flag) {
        localStorage.removeItem("paymentMade");
        setTimeout(() => {
            loadStudents();   // <-- your function that reloads index data
        }, 300);
    }
});

/* ---------------- BOOTSTRAP ----------------
   load fees first (so initializeStudentData has fees available), then student.
*/
(async function init(){
  await loadFees();
  await loadStudent();
})();
</script>

</body>
</html>
