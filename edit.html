<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edit Student</title>

<style>
body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:20px}
.container{max-width:500px;margin:auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
label{display:block;margin-top:10px;font-weight:600}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:6px}
#update{width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;background:#ffc107;color:#000;font-weight:700;margin-top:10px}
.back{background:#007bff;color:#fff;padding:10px;width:100%;border-radius:8px;margin-top:10px;border:none;cursor:pointer}
.warning{color:#d9534f;margin-top:10px;text-align:center;font-weight:600}
.row { display:flex; gap:8px; align-items:center; margin-top:8px; }
#sessionSelect { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
</style>
</head>

<body>
<div class="container">
  <h2>Edit Student Details</h2>

  <label>Session</label>
  <select id="sessionSelect"></select>

  <input type="hidden" id="originalClass"/>
  <input type="hidden" id="originalRoll"/>

  <label>Student Name</label>
  <input id="name"/>

  <label>Father Name</label>
  <input id="father"/>

  <label>Class</label>
  <select id="classSelect">
    <option value="">Select Class</option>
    <option>Nursery</option><option>LKG</option><option>UKG</option>
    <option>1st</option><option>2nd</option><option>3rd</option><option>4th</option>
    <option>5th</option><option>6th</option><option>7th</option><option>8th</option>
    <option>9th</option><option>10th</option>
    <option>11th_Medical</option><option>11th_Commerce</option><option>11th_Art</option>
    <option>12th_Medical</option><option>12th_Commerce</option><option>12th_Art</option>
  </select>

  <label>Roll Number</label>
  <input id="roll" type="number"/>

  <label>Previous Dues</label>
  <input id="previousDue" type="number"/>

  <p class="warning">
    ⚠️ Changing class will reset monthly dues according to new class fee.
  </p>

  <button id="update">Update Details</button>
  <button class="back" onclick="goBack()">⬅ Back</button>
</div>

<script>
/*
  Session-aware Edit Student page.
  - Loads sessions from /session/list
  - Loads fees for the selected session (/fees/get)
  - Loads student from /student/:class/:roll?session=...
  - Updates student using POST /update_student with X-Session header
*/

const API = "/api/proxy?path=";
const urlParams = new URLSearchParams(window.location.search);
const initialRoll = urlParams.get("roll");
const initialClass = urlParams.get("class");

let currentSession = localStorage.getItem("session") || urlParams.get("session") || "2024_25";
let loadedStudent = null;
let sessionFees = {}; // class -> monthly_fee (and annual_fee if returned)

// UI refs
const sessionSelect = document.getElementById("sessionSelect");
const nameInput = document.getElementById("name");
const fatherInput = document.getElementById("father");
const classSelect = document.getElementById("classSelect");
const rollInput = document.getElementById("roll");
const prevDueInput = document.getElementById("previousDue");
const originalClassInput = document.getElementById("originalClass");
const originalRollInput = document.getElementById("originalRoll");

// go back helper
function goBack(){
  // navigate back to index with same session
  location.href = 'index.html?session=' + encodeURIComponent(currentSession);
}

/* --- sessions --- */
async function loadSessions(){
  try {
    const res = await fetch(API + "/session/list");
    const json = await res.json();
    if(!json.success || !Array.isArray(json.sessions)){
      console.warn("session/list returned unexpected:", json);
      sessionSelect.innerHTML = '<option value="2024_25">2024_25</option>';
      currentSession = "2024_25";
      localStorage.setItem("session", currentSession);
      return;
    }
    sessionSelect.innerHTML = "";
    json.sessions.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sessionSelect.appendChild(opt);
    });

    if(!json.sessions.includes(currentSession)){
      currentSession = json.sessions[0];
    }
    sessionSelect.value = currentSession;
    localStorage.setItem("session", currentSession);
  } catch (e) {
    console.error("loadSessions error:", e);
    sessionSelect.innerHTML = '<option value="2024_25">2024_25</option>';
    currentSession = "2024_25";
    localStorage.setItem("session", currentSession);
  }
}

sessionSelect?.addEventListener("change", async () => {
  currentSession = sessionSelect.value;
  localStorage.setItem("session", currentSession);
  // reload fees & student for this session
  await loadFees();
  if (originalClassInput.value && originalRollInput.value) {
    await loadStudent(originalClassInput.value, originalRollInput.value);
  }
});

/* --- fees for session --- */
async function loadFees(){
  sessionFees = {};
  try {
    const res = await fetch(API + "/fees/get", { headers: { "X-Session": currentSession }});
    const json = await res.json();
    if(json && Array.isArray(json.fees)){
      json.fees.forEach(f => {
        sessionFees[f.class_name] = {
          monthly_fee: Number(f.monthly_fee || 0),
          annual_fee: Number(f.annual_fee || f.annual_charge || 0)
        };
      });
    }
  } catch (e) {
    console.error("loadFees error:", e);
  }
}

/* helper to get default monthly fee for a class in current session */
function getFeeForClass(cls){
  if(sessionFees[cls]) return sessionFees[cls].monthly_fee || 0;
  // fallback to built-in default mapping if you want; keep simple:
  return 0;
}

/* --- student load/save --- */
async function loadStudent(cls, roll){
  if(!cls || !roll) {
    // try initial query params
    cls = cls || initialClass;
    roll = roll || initialRoll;
    if(!cls || !roll) return;
  }
  try {
    const url = `${API}/student/${encodeURIComponent(cls)}/${encodeURIComponent(roll)}?session=${encodeURIComponent(currentSession)}`;
    const res = await fetch(url, { headers: { "X-Session": currentSession }});
    const data = await res.json();
    if(!data.success){
      alert("Student not found in session " + currentSession);
      // redirect to index for convenience
      return location.href = 'index.html?session=' + encodeURIComponent(currentSession);
    }

    loadedStudent = data.student || {};
    // fill UI
    nameInput.value = loadedStudent.name || "";
    fatherInput.value = loadedStudent.father || "";
    classSelect.value = loadedStudent.class_name || cls;
    rollInput.value = loadedStudent.roll || roll;
    prevDueInput.value = Number(loadedStudent.previous_due || 0);

    originalClassInput.value = loadedStudent.class_name || cls;
    originalRollInput.value = loadedStudent.roll || roll;
  } catch (e) {
    console.error("loadStudent error:", e);
    alert("Cannot connect to backend for session " + currentSession);
  }
}

/* --- update --- */
document.getElementById("update").addEventListener("click", async () => {
  const newName = nameInput.value.trim();
  const newFather = fatherInput.value.trim();
  const newClass = classSelect.value;
  const newRoll = rollInput.value.trim();
  const newPrevDue = Number(prevDueInput.value || 0);

  const originalClass = originalClassInput.value;
  const originalRoll = originalRollInput.value;

  if (!newName || !newClass || !newRoll) {
    return alert("Please fill all required fields");
  }

  // prepare months: if class changed, reset months using session's fee for newClass
  let updatedMonths = loadedStudent.months || {};

  if (newClass !== originalClass) {
    if (!confirm(`Changing class from ${originalClass} to ${newClass} will reset dues based on new session fees. Continue?`)) {
      return;
    }
    const fee = getFeeForClass(newClass);
    const keys = ["previousDue","Annual","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    updatedMonths = {};
    keys.forEach(m => {
      const due = (m === "previousDue") ? newPrevDue : (m === "Annual" ? (sessionFees[newClass]?.annual_fee || 0) : fee);
      updatedMonths[m] = {
        paid: 0,
        due: Number(due || 0),
        status: Number(due || 0) === 0 ? "Paid" : "Due",
        date: "",
        purpose: m === "Annual" ? "Annual Charge" : (m === "previousDue" ? "Previous Dues" : "Monthly Fee"),
        extra: 0
      };
    });
  }

  const payload = {
    class: originalClass,
    roll: originalRoll,
    student: {
      name: newName,
      father: newFather,
      class_name: newClass,
      roll: newRoll,
      previous_due: newPrevDue,
      advance: (loadedStudent.advance || 0),
      months: updatedMonths
    }
  };

  try {
    const res = await fetch(`${API}/update_student`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Session": currentSession },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.success){
      alert("Student updated successfully!");
      location.href = 'index.html?session=' + encodeURIComponent(currentSession);
    } else {
      alert("Error updating: " + (data.message || JSON.stringify(data)));
    }
  } catch (e) {
    console.error("update error:", e);
    alert("Backend error while updating student");
  }
});

/* --- initial bootstrap --- */
(async function init(){
  await loadSessions();
  await loadFees();
  await loadStudent();
})();
</script>
</body>
</html>
