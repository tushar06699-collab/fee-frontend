<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Edit Student</title>

<style>
body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:20px}
.container{max-width:500px;margin:auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
label{display:block;margin-top:10px;font-weight:600}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:6px}
#update{width:100%;padding:10px;border-radius:8px;border:none;cursor:pointer;background:#ffc107;color:#000;font-weight:700;margin-top:10px}
.back{background:#007bff;color:#fff;padding:10px;width:100%;border-radius:8px;margin-top:10px;border:none;cursor:pointer}
.warning{color:#d9534f;margin-top:10px;text-align:center;font-weight:600}
</style>
</head>

<body>
<div class="container">
  <h2>Edit Student Details</h2>

  <input type="hidden" id="originalClass"/>
  <input type="hidden" id="originalRoll"/>

  <label>Student Name</label>
  <input id="name"/>

  <label>Father Name</label>
  <input id="father"/>

  <label>Class</label>
  <select id="classSelect">
    <option value="">Select Class</option>
    <option>Nursery</option><option>LKG</option><option>UKG</option>
    <option>1st</option><option>2nd</option><option>3rd</option><option>4th</option>
    <option>5th</option><option>6th</option><option>7th</option><option>8th</option>
    <option>9th</option><option>10th</option>
    <option>11th_Medical</option><option>11th_Commerce</option><option>11th_Art</option>
    <option>12th_Medical</option><option>12th_Commerce</option><option>12th_Art</option>
  </select>

  <label>Roll Number</label>
  <input id="roll" type="number"/>

  <label>Previous Dues</label>
  <input id="previousDue" type="number"/>

  <p class="warning">
    ⚠️ Changing class will reset monthly dues according to new class fee.
  </p>

  <button id="update">Update Details</button>
  <button class="back" onclick="location.href='index.html'">⬅ Back</button>
</div>

<script>
const API = "https://fee-backend-ntas.onrender.com";
const params = new URLSearchParams(window.location.search);
const roll = params.get("roll");
const className = params.get("class");

const monthlyFees = {
  "Nursery":1200,"LKG":1300,"UKG":1300,"1st":1300,"2nd":1300,"3rd":1300,"4th":1400,"5th":1400,
  "6th":1500,"7th":1500,"8th":1700,"9th":1900,"10th":1900,
  "11th_Medical":2200,"11th_Commerce":2100,"11th_Art":2100,
  "12th_Medical":2200,"12th_Commerce":2100,"12th_Art":2100
};
function getFee(cls){ return monthlyFees[cls]||0; }

let loadedStudent = null;

// ----------------------- LOAD STUDENT FROM BACKEND -----------------------
async function loadStudent() {
  try {
    const res = await fetch(`${API}/student/${className}/${roll}`);
    const data = await res.json();

    if (!data.success) {
      alert("Student not found");
      return location.href = "index.html";
    }

    loadedStudent = data.student;

    document.getElementById("name").value = loadedStudent.name;
    document.getElementById("father").value = loadedStudent.father;
    document.getElementById("classSelect").value = loadedStudent.class_name;
    document.getElementById("roll").value = loadedStudent.roll;
    document.getElementById("previousDue").value = loadedStudent.previous_due;

    document.getElementById("originalClass").value = loadedStudent.class_name;
    document.getElementById("originalRoll").value = loadedStudent.roll;
  }
  catch (err) {
    alert("❌ Cannot connect to backend");
  }
}

window.onload = loadStudent;


// ----------------------- UPDATE STUDENT -----------------------
document.getElementById("update").onclick = async function () {

  const newName = document.getElementById("name").value.trim();
  const newFather = document.getElementById("father").value.trim();
  const newClass = document.getElementById("classSelect").value;
  const newRoll = document.getElementById("roll").value.trim();
  const newPrevDue = Number(document.getElementById("previousDue").value || 0);

  const originalClass = document.getElementById("originalClass").value;
  const originalRoll = document.getElementById("originalRoll").value;

  if (!newName || !newClass || !newRoll) {
    return alert("Please fill all required fields");
  }

  let updatedMonths = loadedStudent.months;

  // If class changed → reset fee structure
  if (newClass !== originalClass) {
    if (!confirm(`Changing class from ${originalClass} to ${newClass} will reset dues. Continue?`)) {
      return;
    }

    const fee = getFee(newClass);
    updatedMonths = {};

    const keys = ["previousDue","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    keys.forEach(m => {
      updatedMonths[m] = {
        paid: 0,
        due: m === "previousDue" ? newPrevDue : fee,
        status: "Due",
        date: "",
        purpose: "",
        extra: 0
      };
    });
  }

  // Send to backend
  const payload = {
    class: originalClass,
    roll: originalRoll,
    student: {
      name: newName,
      father: newFather,
      class_name: newClass,
      roll: newRoll,
      previous_due: newPrevDue,
      advance: loadedStudent.advance,
      months: updatedMonths
    }
  };

  try {
    const res = await fetch(`${API}/update_student`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      alert("Student updated successfully!");
      location.href = "index.html";
    } else {
      alert("Error: " + data.message);
    }
  }
  catch (err) {
    alert("❌ Backend error");
  }
};
</script>
</body>
</html>
