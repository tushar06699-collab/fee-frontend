<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fee Receipt — P.S. Public School</title>

<style>
body{
    font-family:Arial,sans-serif;
    background:#f3f4f6;
    margin:0;
    padding:20px;
    color:#111;
}

.container{
    max-width:980px;
    margin:auto;
    background:#fff;
    padding:18px;
    border-radius:8px;
    box-shadow:0 6px 18px rgba(0,0,0,.04);
}

.header{
    display:flex;
    align-items:center;
    justify-content:space-between;
}

.header-left{
    display:flex;
    align-items:center;
    gap:12px;
}

.schoolLogo{
    height:48px;
    width:auto;
}

h1{font-size:18px;margin:0;font-weight:700;}

.meta p{margin:6px 0;color:#666;font-size:14px;}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
}

th,td{
    border:1px solid #bbb;
    padding:6px;
    text-align:center;
    font-size:13px;
}

th{background:#eef6ff;}

.controls{
    display:flex;
    gap:10px;
    margin-top:14px;
    align-items:center;
    flex-wrap:wrap;
}

.btn{
    padding:8px 12px;
    border-radius:6px;
    border:0;
    background:#25D366;
    color:#fff;
    cursor:pointer;
}

.btn.gray{background:#6c757d;}
.btn.blue{background:#0d6efd;}

.status{
    padding:8px;
    border-radius:6px;
    margin-top:10px;
    display:none;
}

.status.ok{background:#e6f4ea;color:#0b6b33;display:block;}
.status.err{background:#ffe6e6;color:#b30000;display:block;}

.small{font-size:13px;color:#666;}
.muted{color:#666;font-size:13px;}


/* ---------------------------------- */
/*        PRINT: 4 RECEIPT BOXES      */
/* ---------------------------------- */
@media print {

    body * { visibility: hidden; }

    #printPage, #printPage * {
        visibility: visible;
    }

    #printPage {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 0;
        margin: 0;
    }

    /* EXACT 4 boxes in A4 */
    .print-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        height: 100vh;      /* FULL A4 PAGE */
        padding: 6px;
        gap: 6px;
        box-sizing: border-box;
        page-break-inside: avoid;
    }

    /* FIXED HEIGHT FOR 1/4 PAGE */
    .receipt-box {
        border: 1px solid #000;
        padding: 6px;
        box-sizing: border-box;
        width: 100%;
        height: calc(100vh / 2 - 9px);   /* EXACT 1/4 OF A4 */
        overflow: hidden;
        transform-origin: top left;
        transform: scale(0.92);          /* SHRINK TO FIT */
    }

    /* Reduce inside text to match the small size */
    .receipt-box * {
        font-size: 7px !important;
        line-height: 10px !important;
    }

    .receipt-logo {
        height: 25px !important;
    }
}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <div class="header-left">
      <img src="images/logo1.png" alt="School logo" class="schoolLogo">
      <h1>P.S. Public School – Fee Receipt</h1>
    </div>
    <div style="text-align:right">
      <div id="showTopReceipt" class="muted"></div>
    </div>
  </div>

  <div id="saveStatus" class="status ok"></div>
  <div id="saveError" class="status err"></div>

  <div class="controls">
    <button class="btn gray" onclick="window.location.href='index.html'">Home</button>

    <label>Session:</label>
    <select id="sessionSelect" style="padding:8px;border-radius:6px;border:1px solid #ccc"></select>

    <button class="btn blue" id="btnSave">Save to session</button>
    <button class="btn" id="btnPrint">Print</button>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div class="small">Auto-save: <span id="autoSaveFlag">waiting</span></div>
    </div>
  </div>

  <div id="info" class="meta" style="margin-top:12px"></div>

  <table id="monthsTbl">
    <thead>
      <tr>
        <th>Month</th><th>Paid (₹)</th><th>Due (₹)</th><th>Status</th><th>Purpose</th><th>Extra</th>
      </tr>
    </thead>
    <tbody id="monthsTable"></tbody>
  </table>

  <div style="margin-top:12px">
    <h3 style="display:inline-block;margin:0 12px 0 0">Total Paid: ₹<span id="tPaid"></span></h3>
    <h3 style="display:inline-block;margin:0 12px">Total Due: ₹<span id="tDue"></span></h3>
    <h3 style="display:inline-block;margin:0 12px">Advance Left: ₹<span id="tAdv"></span></h3>
  </div>

  <div style="margin-top:14px" class="small">
    <label>WhatsApp number:
      <input id="waNumber" placeholder="919XXXXXXXXX" style="padding:6px;border-radius:6px;border:1px solid #ccc">
    </label>
    <button class="btn" id="btnWhats">Send to WhatsApp</button>
  </div>
</div>


<!-- PRINT PAGE -->
<div id="printPage" style="display:none;">
  <div class="print-grid" id="printGrid"></div>
</div>


<script>
/* ----------------------------- */
/*           JS LOGIC            */
/* ----------------------------- */

const API = "/api/proxy?path=";
const params = new URLSearchParams(window.location.search);
let dataRaw = params.get("data") || params.get("receipt");
let data = {};

try { data = dataRaw ? JSON.parse(dataRaw) : {}; }
catch(e){ data={}; }

data.name = data.name||"Unknown";
data.father = data.father||"Unknown";
data.class = data.class||"-";
data.roll = data.roll != null ? String(data.roll) : "-";
data.totalPaid = Number(data.totalPaid||0);
data.totalDue = Number(data.totalDue||0);
data.advance = Number(data.advance||0);
data.date = data.date||new Date().toLocaleDateString('en-IN');

data.months = Array.isArray(data.months) ? data.months : (
  data.months ? Object.keys(data.months).map(k=>{
    const v = data.months[k]||{};
    return {
      month:k,
      paid:Number(v.paid||0),
      due:Number(v.due||0),
      status:v.status||"",
      purpose:v.purpose||"",
      extra:Number(v.extra||0)
    };
  }) : []
);

let sessionsList = ["2024_25","2025_26"];
const sel = document.getElementById("sessionSelect");
sessionsList.forEach(s=>{
  const opt=document.createElement("option");
  opt.value=s;
  opt.textContent=s;
  sel.appendChild(opt);
});
data.session = sel.value;

function generateReceiptKey(){
  const rand = String(Math.floor(Math.random()*100000)).padStart(5,"0");
  data.receiptKey = `${data.class}-${data.roll}-${data.session}-${rand}`;
}
generateReceiptKey();

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}

function renderInfo(){
  document.getElementById("info").innerHTML = `
    <p><strong>Name:</strong> ${escapeHtml(data.name)}</p>
    <p class="muted"><strong>Father:</strong> ${escapeHtml(data.father)}</p>
    <p class="muted"><strong>Class:</strong> ${escapeHtml(data.class)} &nbsp; 
    <strong>Roll:</strong> ${escapeHtml(data.roll)}</p>
    <p class="muted"><strong>Session:</strong> ${escapeHtml(data.session)}</p>
    <p class="muted"><strong>Date:</strong> ${escapeHtml(data.date)}</p>
    <p class="small muted"><strong>Receipt Key:</strong> ${escapeHtml(data.receiptKey)}</p>
  `;
}

function renderMonths(){
  const tbody = document.getElementById("monthsTable");
  tbody.innerHTML = (data.months||[]).map(m=>`
    <tr>
      <td>${escapeHtml(m.month)}</td>
      <td style="text-align:right">${escapeHtml(m.paid||0)}</td>
      <td style="text-align:right">${escapeHtml(m.due||0)}</td>
      <td>${escapeHtml(m.status||"")}</td>
      <td>${escapeHtml(m.purpose||"")}</td>
      <td style="text-align:right">${escapeHtml(m.extra||0)}</td>
    </tr>
  `).join("");

  document.getElementById("tPaid").textContent = data.totalPaid;
  document.getElementById("tDue").textContent = data.totalDue;
  document.getElementById("tAdv").textContent = data.advance;
}

function buildReceiptHTML(label){
  const rows = (data.months||[]).map(m=>`
    <tr>
      <td>${m.month||""}</td>
      <td style="text-align:right">${m.paid||0}</td>
      <td style="text-align:right">${m.due||0}</td>
      <td>${m.status||""}</td>
    </tr>
  `).join("");

  return `
  <div class="receipt-box">
    <div style="display:flex;align-items:center;gap:8px;">
      <img src="images/logo1.png" class="receipt-logo" />
      <div><strong>P.S. Public School</strong><br><small>${label}</small></div>
      <div style="margin-left:auto;font-size:12px;"><strong>Receipt Key:</strong> ${data.receiptKey}</div>
    </div>

    <hr>

    <div style="font-size:12px;line-height:16px;">
      Name: ${data.name}<br>
      Father: ${data.father}<br>
      Class: ${data.class} | Roll: ${data.roll}<br>
      Session: ${data.session}<br>
      Date: ${data.date}
    </div>

    <table style="width:100%;border-collapse:collapse;margin-top:5px;font-size:12px;">
      <thead>
        <tr><th>Month</th><th>Paid</th><th>Due</th><th>Status</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>

    <div style="margin-top:6px;font-size:12px;">
      <strong>Total Paid:</strong> ₹${data.totalPaid} &nbsp;&nbsp;
      <strong>Total Due:</strong> ₹${data.totalDue} &nbsp;&nbsp;
      <strong>Advance:</strong> ₹${data.advance}
    </div>

    <div class="signature-box">
      Signature:
      <div class="signature-line"></div>
    </div>
  </div>`;
}

async function saveToSession(){
  try{
    await fetch(`${API}/receipt/add`,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-Session":data.session},
      body: JSON.stringify({...data})
    });

    document.getElementById("saveStatus").innerHTML = 
      `Saved ✔ — Receipt Key: ${data.receiptKey}`;
    document.getElementById("saveStatus").style.display="block";
    document.getElementById("saveError").style.display="none";
    document.getElementById("showTopReceipt").textContent =
      "Receipt Key: " + data.receiptKey;

  }catch(e){
    document.getElementById("saveError").innerText = "Save failed: "+e.message;
    document.getElementById("saveError").style.display="block";
  }
}

function printReceipt(){
  const grid = document.getElementById("printGrid");

  grid.innerHTML = `
    ${buildReceiptHTML("School Copy")}
    ${buildReceiptHTML("Student Copy")}

    <!-- blank boxes -->
    <div class="receipt-box"></div>
    <div class="receipt-box"></div>
  `;

  document.getElementById("printPage").style.display="block";
  window.print();
}


/* BUTTON EVENTS */
document.getElementById("btnSave").addEventListener("click", saveToSession);
document.getElementById("btnPrint").addEventListener("click", printReceipt);

document.getElementById("btnWhats").addEventListener("click", ()=>{
  const num = document.getElementById("waNumber").value.trim();
  if(!num){ alert("Enter WhatsApp number with country code (e.g. 919XXXXXXXXX)"); return; }

  let msg = `P.S. Public School - Fee Receipt\nReceipt Key: ${data.receiptKey}\nName: ${data.name}\nFather: ${data.father}\nClass: ${data.class}\nRoll: ${data.roll}\nSession: ${data.session}\nDate: ${data.date}\n\nDetails:\n`;

  (data.months||[]).forEach(m=>{
    msg += `${m.month}: Paid ${m.paid||0}, Due ${m.due||0}\n`;
  });

  msg += `\nTotal Paid: ${data.totalPaid}\nTotal Due: ${data.totalDue}\nAdvance: ${data.advance}`;

  window.open(`https://wa.me/${num}?text=`+encodeURIComponent(msg), "_blank");
});


renderInfo();
renderMonths();
</script>

</body>
</html>
