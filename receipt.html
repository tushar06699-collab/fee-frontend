<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fee Receipt</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background:#f5f5f5; }
.container { max-width: 650px; margin: auto; border: 1px solid #000; padding: 20px; background:#fff; }
h2 { text-align: center; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #444; padding: 6px; text-align: center; }
th { background: #dff0ff; }
.btn {
    width: 100%;
    padding: 12px;
    margin-top: 20px;
    background: #25D366;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
.btn:hover { background: #1da851; }

.saveMsg {
    background: #d4edda;
    padding: 10px;
    text-align: center;
    color: #155724;
    border-radius: 6px;
    margin-bottom: 10px;
    display:none;
}
</style>
</head>
<body>

<div class="container">

    <h2>P.S. Public School ‚Äì Fee Receipt</h2>

    <div id="saveStatus" class="saveMsg">Receipt Saved Successfully ‚úî</div>

    <div id="info"></div>

    <table>
        <thead>
            <tr>
                <th>Month</th>
                <th>Paid (‚Çπ)</th>
                <th>Due (‚Çπ)</th>
                <th>Status</th>
                <th>Purpose</th>
                <th>Extra</th>
            </tr>
        </thead>
        <tbody id="monthsTable"></tbody>
    </table>

    <h3>Total Paid: ‚Çπ<span id="tPaid"></span></h3>
    <h3>Total Due: ‚Çπ<span id="tDue"></span></h3>
    <h3>Advance Left: ‚Çπ<span id="tAdv"></span></h3>

    <button class="btn" onclick="sendWhatsApp()">Send Receipt to WhatsApp</button>

</div>

<script>
const API = "http://127.0.0.1:5000";

// ---------------------- Load Data ----------------------
let params = new URLSearchParams(window.location.search);
let raw = params.get("data");

let data = {};

try {
    data = JSON.parse(raw);
} catch(e) {
    alert("Invalid receipt data!");
}

// Ensure missing fields don't break UI
data.name = data.name || "Unknown";
data.father = data.father || "Unknown";
data.class = data.class || "-";
data.roll = data.roll || "-";
data.date = data.date || "-";

data.totalPaid = data.totalPaid || 0;
data.totalDue = data.totalDue || 0;
data.advance = data.advance || 0;

data.months = data.months || [];

data.receiptKey = `${data.name}_${data.class}_${data.roll}_${data.date}_${data.totalPaid}`;


// ---------------------- AUTO-SAVE TO BACKEND ----------------------
async function saveReceiptToBackend() {

    try {
        const res = await fetch(`${API}/receipt/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await res.json();

        if (result.success) {
            document.getElementById("saveStatus").style.display = "block";
        } else {
            alert("‚ùå Backend error: " + result.message);
        }

    } catch (err) {
        alert("‚ùå Cannot connect to backend!");
    }
}

saveReceiptToBackend();


// ---------------------- Fill Student Info ----------------------
document.getElementById("info").innerHTML = `
    <p><strong>Name:</strong> ${data.name}</p>
    <p><strong>Father:</strong> ${data.father}</p>
    <p><strong>Class:</strong> ${data.class}</p>
    <p><strong>Roll:</strong> ${data.roll}</p>
    <p><strong>Date:</strong> ${data.date}</p>
`;


// ---------------------- Fill Table ----------------------
let rows = "";
data.months.forEach(m => {
    rows += `
        <tr>
            <td>${m.month}</td>
            <td>${m.paid || 0}</td>
            <td>${m.due || 0}</td>
            <td>${m.status || "-"}</td>
            <td>${m.purpose || "-"}</td>
            <td>${m.extra || 0}</td>
        </tr>
    `;
});
document.getElementById("monthsTable").innerHTML = rows;


// totals
document.getElementById("tPaid").textContent = data.totalPaid;
document.getElementById("tDue").textContent = data.totalDue;
document.getElementById("tAdv").textContent = data.advance;


// ---------------------- WhatsApp ----------------------
function sendWhatsApp() {
    let number = prompt("Enter WhatsApp number (with country code):");
    if (!number) return;

    let msg = `üìò *P.S. Public School Fee Receipt*\n\n`;
    msg += `Name: ${data.name}\n`;
    msg += `Father: ${data.father}\n`;
    msg += `Class: ${data.class}\n`;
    msg += `Roll: ${data.roll}\n`;
    msg += `Date: ${data.date}\n\n`;
    msg += `------ Details ------\n`;

    data.months.forEach(m => {
        msg += `\n${m.month}: Paid ‚Çπ${m.paid}, Due ‚Çπ${m.due}, Status: ${m.status}`;
    });

    msg += `\n\nTotal Paid: ‚Çπ${data.totalPaid}\n`;
    msg += `Total Due: ‚Çπ${data.totalDue}`;

    window.location.href = "https://wa.me/" + number + "?text=" + encodeURIComponent(msg);
}
</script>

</body>
</html>
