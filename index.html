<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student Fee Overview</title>

<style>
  body{font-family:Poppins, sans-serif;background:#f2f4f7;margin:0;padding:0}

  /* LOGIN SCREEN */
  #loginBox{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:#0d6efd;display:flex;justify-content:center;
      align-items:center;z-index:5000;
  }
  #loginCard{
      background:white;padding:30px;border-radius:12px;width:320px;
      box-shadow:0 4px 12px rgba(0,0,0,.25);text-align:center;
  }
  #loginCard h2{margin-bottom:15px;color:#0d6efd;}
  #loginCard input{
      width:100%;padding:10px;margin:8px 0;border-radius:8px;
      border:1px solid #ccc;font-size:16px;
  }
  #loginCard button{
      width:100%;padding:10px;background:#0d6efd;color:white;
      border:0;border-radius:8px;font-size:18px;cursor:pointer;
  }
  #loginCard button:hover{background:#0b5ed7;}

  /* TOP NAV BAR */
  .topbar{
      width:100%;padding:15px 20px;background:#007bff;color:#fff;
      display:flex;justify-content:flex-start;align-items:center;
      gap:15px;box-sizing:border-box;position:sticky;top:0;z-index:4000;
  }

  #sessionSelect {
      padding:4px 8px;border-radius:6px;border:none;font-size:14px;
  }

  #createSessionBtn {
      margin-left:10px;
      padding:6px 10px;
      border-radius:6px;
      border:0;
      background:#28a745;
      color:#fff;
      font-weight:700;
      cursor:pointer;
  }

  /* HAMBURGER */
  .menu-btn{font-size:28px;cursor:pointer;color:#fff;font-weight:900;}

  .overlay {
      position: fixed;top:0;left:0;width:100%;height:100%;
      background: rgba(0,0,0,0.35);display:none;z-index:1500;
  }
  .overlay.show { display:block; }

  .side-menu{
      position:fixed;top:0;left:-280px;width:260px;height:100%;
      background:#fff;box-shadow:2px 0 8px rgba(0,0,0,0.18);
      padding:20px;overflow-y:auto;z-index:2000;
      transition: left 0.35s;
      border-radius:0 18px 18px 0;
  }
  .side-menu.open{ left:0; }

  .menu-item{
      padding:12px 0;border-bottom:1px solid #eee;cursor:pointer;
      font-size:16px;font-weight:600;color:#333;
  }

  .container{
      max-width:1600px;margin:auto;background:#fff;padding:25px;
      border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08);
      margin-top:15px
  }

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e6e6e6;padding:8px;text-align:center;font-size:14px}
  th{background:#007bff;color:#fff}

  .paid{background:#c8ffc8;color:#0b7a0b;font-weight:700}
  .partial{background:#fff3bf;color:#7a5a00;font-weight:700}
  .due{background:#ffd2d2;color:#b30000;font-weight:700}

  .class-row td{
      background:#222;color:#fff;text-align:left;padding-left:12px;
      font-weight:700
  }

  .student-name{color:#007bff;cursor:pointer;font-weight:600}

  #search{
      padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;
      margin-top:15px
  }

  .edit-btn{
      margin-top:4px;padding:4px 8px;font-size:12px;background:#ffc107;
      border:none;border-radius:6px;cursor:pointer;
  }

  td:last-child, th:last-child {
    background:#eaf2ff;
    font-weight:700;
    color:#004aad;
}

  .prev-green{color:#0b7a0b;font-weight:700;}
  .prev-red{color:#b30000;font-weight:700;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
    <div id="loginCard">
        <h2>Admin Login</h2>
        <input id="username" placeholder="Username">
        <input id="password" type="password" placeholder="Password">
        <button onclick="doLogin()">Login</button>
    </div>
</div>

<script>
function doLogin(){
    let u = document.getElementById("username").value.trim();
    let p = document.getElementById("password").value.trim();

    
    if (u === "admin" && p === "1234") {
    localStorage.setItem("loggedIn", "yes");
    document.getElementById("loginBox").style.display = "none";
} else {
    alert("Invalid credentials");
}
}

if (localStorage.getItem("loggedIn") === "yes") {
    document.getElementById("loginBox").style.display = "none";
}
</script>

<!-- TOP BAR -->
<div class="topbar">
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    <div style="font-size:20px;font-weight:600;">P.S. Public School</div>

    <div style="margin-left:auto; display:flex; align-items:center;">
        <select id="sessionSelect" onchange="changeSession()"></select>
    </div>
</div>

<!-- SIDEBAR -->
<div id="overlay" class="overlay" onclick="closeMenu()"></div>
<div class="side-menu" id="sideMenu">
    <div class="menu-item" onclick="goToPage('edit.html')">‚úèÔ∏è Edit Student</div>
    <div class="menu-item" onclick="goToPage('dashboard.html')">üìä Dashboard</div>
    <div class="menu-item" onclick="goToPage('add_student.html')">‚ûï Add Student</div>
    <div class="menu-item" onclick="goToPage('fees.html')">üí∞ Fees Modify</div>
    <div class="menu-item" onclick="goToPage('import_students.html')">üì• Import Students</div>
    <div class="menu-item" onclick="goToPage('receipt_history.html')">üìú Receipt History</div>
    <div class="menu-item" onclick="goToPage('delete_student.html')">üóë Delete Students</div>
    <div class="menu-item" onclick="goToPage('export.html')">üì§ Export Data</div>

</div>

<script>
function toggleMenu(){ sideMenu.classList.toggle("open"); overlay.classList.toggle("show"); }
function closeMenu(){ sideMenu.classList.remove("open"); overlay.classList.remove("show"); }
function goToPage(p){ window.location.href = p + "?session=" + currentSession; }
</script>

<div class="container">
  <input id="search" placeholder="Search by name, roll, class..." />
  <table id="feeTable">
    <thead>
  <tr>
    <th>Student</th>
    <th>Class</th>
    <th>Roll</th>
    <th>Prev Due</th>
    <th>Apr</th>
    <th>May</th>
    <th>Jun</th>
    <th>Jul</th>
    <th>Aug</th>
    <th>Sep</th>
    <th>Oct</th>
    <th>Nov</th>
    <th>Dec</th>
    <th>Jan</th>
    <th>Feb</th>
    <th>Mar</th>
    <th>Total Due</th>
  </tr>
</thead>

    <tbody id="feeRows"></tbody>
  </table>
</div>

<script>
const API = "/api/proxy?path=";
let currentSession = localStorage.getItem("session") || "2024_25";
const allMonths = [
    "Apr","May","Jun","Jul","Aug","Sep",
    "Oct","Nov","Dec","Jan","Feb","Mar"
];

/* -------------- SESSIONS ---------------- */
async function loadSessions(){
    try{
        const res = await fetch(API + "/session/list");
        const data = await res.json();

        let sel = sessionSelect;
        sel.innerHTML = "";

        data.sessions.forEach(s => {
            sel.innerHTML += `<option value="${s}">${s}</option>`;
        });

        if(!data.sessions.includes(currentSession)) currentSession = data.sessions[0];
        sel.value = currentSession;
        localStorage.setItem("session", currentSession);

    } catch(e){
        alert("Error loading sessions");
        console.error(e);
    }
}


async function createNewSession() {
    let from = currentSession;

    let extra = prompt("Enter extra fee to add (or 0):", "0");
    if(extra === null) return; // Cancel clicked

    extra = parseInt(extra) || 0;

    try {
        const res = await fetch(API + "/session/create_auto", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Session": from
            },
            body: JSON.stringify({
                from_session: from,
                extra_fee: extra
            })
        });

        const data = await res.json();

        if (!data.success) {
            alert("Session create failed: " + data.message);
            return;
        }

        alert("New session created: " + data.new_session);

        // reload dropdown
        await loadSessions();

        sessionSelect.value = data.new_session;
        changeSession();

    } catch (e) {
        alert("Error: " + e);
        console.error(e);
    }
}

function changeSession(){
    currentSession = sessionSelect.value;
    localStorage.setItem("session", currentSession);
    renderTable();
}

/* ----------- FIXED FETCH STUDENTS ----------- */
async function fetchStudents(){
    const headers = { "X-Session": currentSession };

    try{
        const res = await fetch(API + "/students", { headers });
        const text = await res.text();

        let json = null;
        try{ json = JSON.parse(text); } catch(e){}

        if(!res.ok || (json && json.success === false)){
            alert("Students load failed: " + (json?.message || json?.error || res.status));
            return [];
        }

        return json?.students || [];
    }
    catch(e){
        alert("Cannot load students from backend");
        console.error(e);
        return [];
    }
}

/* ----------------- TABLE ----------------- */
async function renderTable(filter = "") {
    const tbody = feeRows;
    tbody.innerHTML = "";

    let students = await fetchStudents();
    students.sort((a, b) => (a.class_name || "").localeCompare(b.class_name || ""));

    let curClass = null;

    students.forEach(s => {
        s.months = s.months || {};

        let match = (
            (s.name || "") + " " +
            (s.father || "") + " " +
            (s.roll || "") + " " +
            (s.class_name || "")
        ).toLowerCase();

        if (filter && !match.includes(filter.toLowerCase())) return;

        if (s.class_name !== curClass) {
            curClass = s.class_name;
            tbody.innerHTML += `<tr class="class-row"><td colspan="17">Class: ${curClass}</td></tr>`;
        }

        let prevClass = s.previous_due === 0 ? "prev-green" : "prev-red";

        const monthOrder = [
            
             // üî• REQUIRED FIX
            "Apr","May","Jun","Jul","Aug","Sep",
            "Oct","Nov","Dec","Jan","Feb","Mar"
        ];

        let monthsHtml = "";
        let totalDue = 0;

        monthOrder.forEach(m => {
            let val = s.months[m] || {status: "Due", due: 0};
            let cls = val.status === "Paid" ? "paid" :
                      val.status === "Partial" ? "partial" : "due";

            monthsHtml += `<td class="${cls}">${val.status}</td>`;
            totalDue += val.due || 0;
        });
        totalDue += s.previous_due || 0;


        tbody.innerHTML += `
        <tr>
          <td>
              <span class="student-name" data-roll="${s.roll}" data-class="${s.class_name}">
                  ${s.name}
              </span><br>
              <button class="edit-btn" data-roll="${s.roll}" data-class="${s.class_name}">‚úè Edit</button>
          </td>
          <td>${s.class_name}</td>
          <td>${s.roll}</td>

          <!-- previous due cell -->
          <td class="${prevClass}">
              ${s.months.previousDue ? s.months.previousDue.due : s.previous_due}
          </td>

          <!-- insert all months including annual -->
          ${monthsHtml}

          <td style="font-weight:700;color:#0047b3;background:#e8f0ff;">${totalDue}</td>
        </tr>`;
    });

    document.querySelectorAll(".student-name").forEach(el => {
        el.onclick = () => {
            window.location.href =
                `student_details.html?roll=${el.dataset.roll}&class=${el.dataset.class}&session=${currentSession}`;
        };
    });

    document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.onclick = () => {
            window.location.href =
                `edit.html?roll=${btn.dataset.roll}&class=${btn.dataset.class}&session=${currentSession}`;
        };
    });
}

window.addEventListener("focus", () => {
    const flag = localStorage.getItem("paymentMade");
    if (flag) {
        localStorage.removeItem("paymentMade");

        // Reload full student list automatically
        setTimeout(() => {
            renderTable();    // ‚úî correct function
        }, 300);
    }
});


search.oninput = e => renderTable(e.target.value);

/* INIT */
loadSessions().then(renderTable);

/* üî• AUTO REFRESH WHEN PAYMENT IS MADE IN student_detail.html */

</script>

</body>
</html>
